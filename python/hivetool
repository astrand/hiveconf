#!/usr/bin/env python2
# -*-Python-*-

import hiveconf
import getopt
import sys

VERSION="0.0"
DEFAULTTYPE="string"


def get_type(s):
    """Parse parameter string. Returns (type, parameter)"""
    words = s.split(":", 1)
    if not words[1:]:
        # No colon in string
        return (DEFAULTTYPE, s)
    
    (beforecolon, aftercolon) = words
    if beforecolon in ("string", "bool", "integer", "float", "binary",
                       "string_list", "bool_list", "integer_list",
                       "float_list", "binary_list"):
        return (beforecolon, aftercolon)
    else:
        return (DEFAULTTYPE, s)


def get_value(s):
    """Parse parameter string. Returns (parameterpath, value)"""
    words = s.split("=", 1)
    if not words[1:]:
        # No equal sign in string
        return (s, None)
    else:
        return tuple(words)


def handle_param(hive, param):
    (paramtype, param) = get_type(param)
    (parampath, value) = get_value(param)

    method = getattr(hive, "get_%s" % paramtype)
        
    if not value:
        # Display value
        print method(parampath)
    else:
        # Set value
        method(parampath, value)


def usage():
    print >>sys.stderr, """
hivetool [options] parameter[=value] ...

  -a,--all-entries      Print all parameters and values in a folder
  -R,--recursive	When using -a, ascend folders recursively
  -t,--type <type>	Set type for the next listed parameters. Type is one of:
			string, bool, integer, float, binary,
			string_list, bool_list, integer_list, float_list, binary_list
			Default is string
  -r,--root <file>	Specify root hive file. Default is /etc/root.hive
  -v,--version		Print version
  -?,--help		Show this help message
"""



def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], "a:Rr:v?",
                                   ["all-entries=", "recursive", "root=", "version", "help"])
    except getopt.GetoptError:
        usage()
        sys.exit(2)

    roothive = "/etc/hive.root"
    walk_folders = []
    recursive = 0
    for o, a in opts:
        if o in ("-a", "--all-entries"):
            walk_folders.append(a)
        if o in ("-R", "--recursive"):
            recursive = 1
        if o in ("-r", "--root"):
            roothive = a
        if o in ("-v", "--version"):
            print >> sys.stderr, "hivetool version", VERSION
            sys.exit(0)
        if o in ("-?", "--help"):
            usage()
            sys.exit(0)

    # Try to open root hive
    hive = hiveconf.open_hive(roothive)

    # Get/set listed parameters
    for param in args:
        handle_param(hive, param)

    # Walk
    for foldername in walk_folders:
        folder = hive.lookup(foldername)
        if not folder:
            print >>sys.stderr, "Folder '%s' not found" % foldername
            continue

        folder.walk(recursive)


if __name__ == "__main__":
    main()

